<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>MoreTranz Halftone Tool</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 820px;
        margin: 24px auto;
        padding: 0 16px;
        background: #fff;
      }

      .grid {
        display: grid;
        grid-template-columns: minmax(320px, 360px) minmax(340px, 1fr);
        gap: 16px;
        align-items: start;
      }

      @media (max-width: 760px) {
        .grid { grid-template-columns: 1fr; }
      }

      .card {
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 16px;
        background: #fff;
      }

      label { display:block; font-size: 14px; margin: 12px 0 6px; font-weight: 600; }
      input[type="range"] { width: 100%; }
      select, input[type="file"], button, input[type="text"] { width: 100%; padding: 10px; font-size: 14px; }
      button { cursor: pointer; }
      button[disabled] { cursor: not-allowed; opacity: 0.6; }

      .muted { color:#666; font-size: 12px; line-height: 1.35; }
      .ok { color: #0a7a0a; font-weight: 600; }
      .err { color: #b00020; white-space: pre-wrap; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 12px; }

      .imgWrap { width: 100%; }
      img {
        display: block;
        width: 100%;
        height: auto;
        max-width: 100%;
        border: 1px solid #eee;
        border-radius: 8px;

        background:
          linear-gradient(45deg, #eee 25%, transparent 25%),
          linear-gradient(-45deg, #eee 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #eee 75%),
          linear-gradient(-45deg, transparent 75%, #eee 75%);
        background-size: 20px 20px;
        background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      }

      .btnRow { display:flex; gap:10px; }
      .btnRow button { flex: 1 1 auto; }

      .pill {
        display:inline-block;
        font-size: 12px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid #ddd;
        background: #fafafa;
        margin-left: 8px;
        vertical-align: middle;
      }

      a.linkBtn {
        display: inline-block;
        margin-top: 10px;
        font-size: 13px;
        text-decoration: none;
        color: #0b66c3;
      }
      a.linkBtn:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <h1>MoreTranz Halftone Tool</h1>
    <p class="muted">
      Uploads to Cloudflare R2, processes on Render, returns a downloadable PNG.
      <span class="pill">Tip: 12&quot; @ 300dpi = 3600px</span>
    </p>

    <div class="grid">
      <div class="card">
        <h3>1) Choose image</h3>
        <input id="file" type="file" accept="image/png,image/jpeg,image/webp" />
        <div id="fileInfo" class="muted"></div>

        <h3 style="margin-top:18px;">2) Settings</h3>

        <label>Dot shape</label>
        <select id="dotShape">
          <option value="circle" selected>circle (default)</option>
          <option value="ellipse">ellipse</option>
          <option value="square">square</option>
        </select>

        <label>Cell size: <span id="cellSizeVal">12</span></label>
        <input id="cellSize" type="range" min="6" max="30" step="1" value="12" />
        <div class="muted">Smaller = more detail but more CPU/RAM.</div>

        <label style="margin-top:14px;">Max width: <span id="maxWidthVal">3600</span> px</label>
        <input id="maxWidth" type="range" min="800" max="4000" step="50" value="3600" />
        <div class="muted">For 12&quot; @ 300dpi, use 3600. Reduce if performance is slow.</div>

        <label style="margin-top:14px;">
          Strength: <span id="strengthVal">120</span>
          <span id="strengthLabel" class="pill" style="display:none;"></span>
        </label>
        <input id="strength" type="range" min="50" max="250" step="10" value="120" />
        <div class="muted">
          100 = baseline. Higher = darker/more dot coverage (try 150–250 for DTF-style richness).
        </div>

        <label style="margin-top:14px;">API base URL</label>
        <input id="apiBase" class="mono" type="text" value="https://moretranz-halftone.onrender.com" />

        <div class="btnRow" style="margin-top:14px;">
          <button id="go">Generate Halftone</button>
          <button id="reset" type="button">Reset defaults</button>
        </div>

        <div id="status" style="margin-top:12px;"></div>
        <div id="debug" class="mono muted" style="margin-top:10px;"></div>
      </div>

      <div class="card">
        <h3>Preview</h3>

        <div class="muted">Original</div>
        <div class="imgWrap">
          <img id="origPreview" alt="" />
        </div>

        <div style="height:12px;"></div>

        <div class="muted">Halftone output</div>
        <div class="imgWrap">
          <img id="outPreview" alt="" />
        </div>

        <button id="download" style="margin-top:12px;" disabled>Download PNG</button>
        <a id="openLink" class="linkBtn" href="#" target="_blank" rel="noreferrer" style="display:none;">Open output in new tab</a>
      </div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);

      const fileEl = $("file");
      const fileInfo = $("fileInfo");
      const origPreview = $("origPreview");
      const outPreview = $("outPreview");
      const statusEl = $("status");
      const debugEl = $("debug");
      const goBtn = $("go");
      const resetBtn = $("reset");
      const dlBtn = $("download");
      const openLink = $("openLink");

      const apiBase = $("apiBase");
      const cellSize = $("cellSize");
      const maxWidth = $("maxWidth");
      const strength = $("strength");
      const dotShape = $("dotShape");

      const cellSizeVal = $("cellSizeVal");
      const maxWidthVal = $("maxWidthVal");
      const strengthVal = $("strengthVal");
      const strengthLabel = $("strengthLabel");

      cellSize.addEventListener("input", () => (cellSizeVal.textContent = cellSize.value));
      maxWidth.addEventListener("input", () => (maxWidthVal.textContent = maxWidth.value));

      function updateStrengthUI() {
        const v = Number(strength.value);
        strengthVal.textContent = String(v);

        // Exact labels only. No ranges. No approximations.
        const map = {
          100: "Light",
          150: "Normal",
          200: "Bold",
          250: "Extra Bold"
        };

        const label = map[v];
        if (label) {
          strengthLabel.textContent = label;
          strengthLabel.style.display = "inline-block";
        } else {
          strengthLabel.textContent = "";
          strengthLabel.style.display = "none";
        }
      }

      strength.addEventListener("input", updateStrengthUI);

      let lastDownloadUrl = null;
      let busy = false;

      resetBtn.addEventListener("click", () => {
        dotShape.value = "circle";
        cellSize.value = 12;
        maxWidth.value = 3600;
        strength.value = 120;

        cellSizeVal.textContent = "12";
        maxWidthVal.textContent = "3600";

        updateStrengthUI();
        setStatus("");
        setDebug("");
      });

      fileEl.addEventListener("change", () => {
        const f = fileEl.files?.[0];
        if (!f) return;

        fileInfo.textContent = `${f.name} — ${f.type || "unknown"} — ${f.size.toLocaleString()} bytes`;
        origPreview.src = URL.createObjectURL(f);

        outPreview.removeAttribute("src");
        dlBtn.disabled = true;
        openLink.style.display = "none";
        openLink.href = "#";
        lastDownloadUrl = null;

        setStatus("");
        setDebug("");
      });

      function setStatus(msg, kind = "") {
        statusEl.className = kind === "err" ? "err" : (kind === "ok" ? "ok" : "");
        statusEl.textContent = msg;
      }

      function setDebug(msg) {
        debugEl.textContent = msg;
      }

      async function readBody(resp) {
        const ct = resp.headers.get("content-type") || "";
        if (ct.includes("application/json")) return await resp.json();
        return await resp.text();
      }

      function cleanBaseUrl(s) {
        return (s || "").trim().replace(/\/+$/, "");
      }

      goBtn.addEventListener("click", async () => {
        if (busy) return;

        const f = fileEl.files?.[0];
        if (!f) return setStatus("Please choose an image first.", "err");

        const allowed = ["image/png", "image/jpeg", "image/webp"];
        if (!allowed.includes(f.type)) return setStatus(`Unsupported type: ${f.type}`, "err");

        const base = cleanBaseUrl(apiBase.value);
        if (!base) return setStatus("API base URL is empty.", "err");

        busy = true;
        goBtn.disabled = true;
        resetBtn.disabled = true;
        dlBtn.disabled = true;
        openLink.style.display = "none";
        openLink.href = "#";
        lastDownloadUrl = null;

        setStatus("Working…");
        setDebug("");

        try {
          const upResp = await fetch(`${base}/v1/halftone/upload-url`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              filename: f.name,
              contentType: f.type,
              contentLength: f.size
            })
          });

          if (!upResp.ok) {
            const body = await readBody(upResp);
            throw new Error(
              `upload-url failed (${upResp.status}): ${typeof body === "string" ? body : JSON.stringify(body, null, 2)}`
            );
          }

          const up = await upResp.json();

          const putResp = await fetch(up.uploadUrl, {
            method: "PUT",
            headers: up.headers || { "Content-Type": f.type },
            body: f
          });

          if (!putResp.ok) {
            const txt = await putResp.text().catch(() => "");
            throw new Error(`R2 PUT failed (${putResp.status}): ${txt || "no body"}`);
          }

          const payload = {
            key: up.key,
            cellSize: Number(cellSize.value),
            maxWidth: Number(maxWidth.value),
            dotShape: dotShape.value,
            strength: Number(strength.value)
          };

          const procResp = await fetch(`${base}/v1/halftone/process`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!procResp.ok) {
            const body = await readBody(procResp);
            throw new Error(
              `process failed (${procResp.status}): ${typeof body === "string" ? body : JSON.stringify(body, null, 2)}`
            );
          }

          const proc = await procResp.json();

          if (!proc.downloadUrl) {
            throw new Error(`process response missing downloadUrl: ${JSON.stringify(proc, null, 2)}`);
          }

          lastDownloadUrl = proc.downloadUrl;
          outPreview.src = proc.downloadUrl;

          openLink.href = proc.downloadUrl;
          openLink.style.display = "inline-block";

          dlBtn.disabled = false;

          setStatus("Done ✅", "ok");
          setDebug(
            `uploadKey: ${up.key}\n` +
            `outputKey: ${proc.outputKey || "(not provided)"}\n` +
            `downloadUrl: ${proc.downloadUrl}\n` +
            `ms: ${proc.ms ?? "(n/a)"}`
          );
        } catch (err) {
          setStatus(String(err?.message || err), "err");
        } finally {
          busy = false;
          goBtn.disabled = false;
          resetBtn.disabled = false;
        }
      });

      dlBtn.addEventListener("click", async () => {
        if (!lastDownloadUrl) return;

        const resp = await fetch(lastDownloadUrl);
        if (!resp.ok) {
          const t = await resp.text().catch(() => "");
          setStatus(`Download failed (${resp.status}): ${t || "no body"}`, "err");
          return;
        }

        const blob = await resp.blob();
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "halftone.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      });

      // initialize label on first load
      updateStrengthUI();
    </script>
  </body>
</html>
